import streamlit as st
import google.generativeai as genai

# 1. CONFIGURE THE APP
st.set_page_config(page_title="The Long Road Back", page_icon="ðŸª–")

st.title("The Long Road Back")
st.caption("A WW2 Interactive Drama powered by Google Gemini")

# 2. SETUP GEMINI AI
# (You will paste your API key in the secrets manager later, or replace 'st.secrets' below)
# For now, we assume the user puts the key in the sidebar for testing
with st.sidebar:
    api_key = st.text_input("Enter Google Gemini API Key", type="password")
    st.markdown("[Get a key here](https://aistudio.google.com/app/apikey)")

# 3. THE "BRAIN" (System Instructions)
SYSTEM_PROMPT = """
You are an interactive Game Master for a WW2 drama titled "The Long Road Back."
THE PREMISE: Two protagonists separated by war, trying to reunite in France, 1944.
1. JOHN: US Soldier (Action/Gritty). 2. MARIE: French Civilian (Stealth/Tension).
RULES:
1. Present vivid scenes (2-3 paragraphs).
2. Display a STATUS BAR at the end of every turn: [Health] | [Morale] | [Distance] | [Inventory].
3. Offer 3 distinct choices (A, B, C). Choice C must be an Emotional Memory flashback.
4. Keep track of logic. No reunion until turn 10.
START GAME immediately. Ask the user to choose John or Marie.
"""

# 4. INITIALIZE CHAT SESSION
if "messages" not in st.session_state:
    st.session_state.messages = []
    # We add the system prompt invisibly so the AI knows what to do
    st.session_state.chat_session = None

# 5. DISPLAY CHAT HISTORY
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# 6. HANDLE USER INPUT
if prompt := st.chat_input("Make your choice..."):
    if not api_key:
        st.error("Please enter an API Key in the sidebar to play.")
        st.stop()

    # Configure the model
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel("gemini-1.5-flash") # Using Flash for speed/cost

    # Start chat if not started
    if st.session_state.chat_session is None:
        history = [
            {"role": "user", "parts": [SYSTEM_PROMPT]},
            {"role": "model", "parts": ["Understood. I am ready to begin the story."]}
        ]
        st.session_state.chat_session = model.start_chat(history=history)

    # Add user message to UI
    st.chat_message("user").markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # Get AI response
    try:
        response = st.session_state.chat_session.send_message(prompt)
        
        # Display AI response
        with st.chat_message("assistant"):
            st.markdown(response.text)
        
        # Save AI response to history
        st.session_state.messages.append({"role": "assistant", "content": response.text})
        
    except Exception as e:
        st.error(f"An error occurred: {e}")
